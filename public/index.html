<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workshop Fiber + GORM</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:720px;margin:24px auto;padding:0 12px}
    input,button{padding:10px 12px;font-size:16px}
    input{width:260px}
    button{cursor:pointer}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    ul{padding-left:18px}
    li{margin:6px 0}
    small{color:#666}
    code{background:#f5f5f5;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h1>Workshop Fiber + GORM (No gRPC)</h1>
  <p><small>FE แบบขั้นต่ำสุด แค่เรียก API ได้พอ ✅</small></p>

  <div class="row">
    <input id="name" placeholder="name" />
    <input id="email" placeholder="email" />
    <button onclick="createUser()">Add</button>
    <button onclick="loadUsers()">Reload</button>
  </div>

  <p><small>API: <code>GET /api/users</code>, <code>POST /api/users</code></small></p>

  <ul id="list"></ul>

<script>
async function loadUsers(){
  const res = await fetch("/api/users");
  const data = await res.json();
  const list = document.getElementById("list");
  list.innerHTML = "";
  data.forEach(u => {
    const li = document.createElement("li");
    li.innerHTML = `<b>#${u.id}</b> ${escapeHtml(u.name)} — ${escapeHtml(u.email)} 
      <button onclick="delUser(${u.id})">delete</button>`;
    list.appendChild(li);
  });
}

async function createUser(){
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  if(!name || !email){ alert("name/email required"); return; }
  const res = await fetch("/api/users",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({name,email})
  });
  if(!res.ok){
    const err = await res.json().catch(()=>({error:"unknown"}));
    alert(err.error || "error");
    return;
  }
  document.getElementById("name").value="";
  document.getElementById("email").value="";
  loadUsers();
}

async function delUser(id){
  const ok = confirm("delete user #" + id + "?");
  if(!ok) return;
  const res = await fetch("/api/users/" + id, { method:"DELETE" });
  if(res.status !== 204){
    const err = await res.json().catch(()=>({error:"unknown"}));
    alert(err.error || "error");
    return;
  }
  loadUsers();
}

function escapeHtml(str){
  return str.replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;","'":"&#039;"
  }[m]));
}

loadUsers();
</script>
</body>
</html>
